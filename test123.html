<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Kalender Agent v2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        .user-bubble {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
        }
        .agent-bubble {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="main-container" class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Ihr intelligentes Agenten-Team</h1>
            <p class="text-gray-600 mt-2">Verwalten Sie Termine und Kontakte mit Ihren KI-Assistenten.</p>
        </header>

        <!-- Login Section -->
        <div id="login-section" class="text-center p-8 bg-white rounded-2xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4">Willkommen!</h2>
            <p class="mb-6">Bitte melden Sie sich mit Ihrem Google-Konto an, um fortzufahren.</p>
            <button id="login-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 inline-flex items-center">
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.986,36.68,44,31.016,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Mit Google anmelden
            </button>
        </div>

        <!-- App Content Section -->
        <div id="app-content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Calendar View -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Diese Woche</h2>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition">Abmelden</button>
                </div>
                <div id="calendar-events" class="space-y-4">
                     <div id="calendar-loader" class="text-center p-4 hidden">
                         <div class="loader inline-block"></div>
                         <p class="mt-2 text-gray-500">Lade Termine...</p>
                     </div>
                </div>
            </div>

            <!-- Agent Chat -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg flex flex-col h-[70vh]">
                <h2 class="text-2xl font-bold mb-4 border-b pb-4">Chat mit Ihrem Agenten-Team</h2>
                <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 flex flex-col">
                </div>
                 <div id="agent-loader" class="p-4 self-start hidden">
                     <div class="flex items-center space-x-2">
                         <div class="loader"></div>
                         <span class="text-gray-500">Agenten koordinieren...</span>
                     </div>
                 </div>
                <div class="mt-4 pt-4 border-t">
                    <div class="flex space-x-3">
                        <input type="text" id="chat-input" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Fragen Sie etwas...">
                        <button id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Senden</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <script type="module">
        // Firebase Imports
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- CONFIGURATION ---
        console.log("LOG: Skript wird initialisiert.");
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "YOUR_API_KEY", // Replace with your actual Firebase config
            authDomain: "YOUR_AUTH_DOMAIN",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- INITIALIZATION ---
        setLogLevel('debug');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        console.log("LOG: Firebase App, Auth und Firestore initialisiert.");

        // --- DOM ELEMENTS ---
        const loginSection = document.getElementById('login-section');
        const appContent = document.getElementById('app-content');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const calendarEventsContainer = document.getElementById('calendar-events');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const calendarLoader = document.getElementById('calendar-loader');
        const agentLoader = document.getElementById('agent-loader');

        let accessToken = null;
        let currentUserId = null;

        // --- AUTHENTICATION FLOW ---
        onAuthStateChanged(auth, (user) => {
            updateUI(user);
        });

        loginButton.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            // Requesting broader permissions to create, edit, and delete events
            provider.addScope('https://www.googleapis.com/auth/calendar.events');
            provider.addScope('https://www.googleapis.com/auth/calendar.readonly');
            
            signInWithPopup(auth, provider)
                .then((result) => {
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    const token = credential ? credential.accessToken : null;
                    updateUI(result.user, token);
                })
                .catch((error) => {
                    console.error("LOG: Fehler bei signInWithPopup:", error.code, error.message);
                });
        });

        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });

        async function updateUI(user, freshAccessToken = null) {
            if (freshAccessToken) accessToken = freshAccessToken;

            if (user) {
                currentUserId = user.uid;
                loginSection.classList.add('hidden');
                appContent.classList.remove('hidden');
                
                if (accessToken) {
                    chatHistory.innerHTML = '';
                    addMessageToChat('agent', 'Hallo! Ich bin Ihr persönlicher Koordinator. Meine Spezialisten für Kalender und Kontakte stehen bereit. Wie kann ich Ihnen helfen?');
                    await fetchCalendarEvents();
                } else {
                    calendarEventsContainer.innerHTML = '<p class="text-gray-500">Bitte melden Sie sich ab und erneut an, um den Kalenderzugriff zu erneuern.</p>';
                    addMessageToChat('agent', 'Der Zugriff auf den Kalender ist abgelaufen. Bitte melden Sie sich ab und erneut an.');
                }
            } else {
                accessToken = null;
                currentUserId = null;
                loginSection.classList.remove('hidden');
                appContent.classList.add('hidden');
                calendarEventsContainer.innerHTML = '';
                chatHistory.innerHTML = '';
            }
        }
        
        // --- GOOGLE CALENDAR API WRAPPER ---
        async function apiCall(url, options) {
            if (!accessToken) throw new Error("Kein Zugriffstoken vorhanden. Bitte neu anmelden.");
            const defaultHeaders = { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' };
            const response = await fetch(url, { ...options, headers: { ...defaultHeaders, ...options.headers } });
            if (!response.ok) {
                const errorData = await response.json();
                console.error("LOG: Google API Fehler:", errorData);
                throw new Error(errorData.error.message || `API-Anfrage fehlgeschlagen mit Status ${response.status}`);
            }
            // DELETE request might not return a body
            return response.status === 204 ? null : response.json();
        }

        async function fetchCalendarEvents(timeMin, timeMax) {
            calendarLoader.classList.remove('hidden');
            calendarEventsContainer.innerHTML = '';

            const now = new Date();
            const startOfWeek = timeMin || new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 1).toISOString();
            const endOfWeek = timeMax || new Date(now.getFullYear(), now.getMonth(), now.getDate() + (7 - now.getDay())).toISOString();
            
            const url = `https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${startOfWeek}&timeMax=${endOfWeek}&singleEvents=true&orderBy=startTime`;
            
            try {
                const data = await apiCall(url, { method: 'GET' });
                displayEvents(data.items);
                return data.items;
            } catch (error) {
                console.error("LOG: Fehler beim Abrufen von Kalenderereignissen:", error);
                calendarEventsContainer.innerHTML = `<p class="text-red-500">Fehler: ${error.message}</p>`;
                return [];
            } finally {
                calendarLoader.classList.add('hidden');
            }
        }

        function displayEvents(events) {
            calendarEventsContainer.innerHTML = '';
            if (events && events.length > 0) {
                events.forEach(event => {
                    const start = event.start.dateTime || event.start.date;
                    const startDate = new Date(start);
                    const options = { weekday: 'long', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                    const formattedDate = event.start.dateTime ? startDate.toLocaleDateString('de-DE', options) : startDate.toLocaleDateString('de-DE', { weekday: 'long', month: 'long', day: 'numeric' });

                    const eventElement = document.createElement('div');
                    eventElement.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200';
                    eventElement.innerHTML = `
                        <h3 class="font-semibold text-blue-600">${event.summary}</h3>
                        <p class="text-sm text-gray-600">${formattedDate}</p>
                    `;
                    calendarEventsContainer.appendChild(eventElement);
                });
            } else {
                calendarEventsContainer.innerHTML = '<p class="text-gray-500">Keine Termine in diesem Zeitraum gefunden.</p>';
            }
        }

        // --- SPECIALIST AGENT: CALENDAR TOOL ---
        async function handleCalendarTool(params) {
            console.log("LOG: Kalender-Agent wurde aktiviert mit Parametern:", params);
            switch (params.operation) {
                case "CREATE":
                    const attendees = params.attendees ? params.attendees.map(email => ({ email })) : [];
                    const eventData = {
                        summary: params.summary,
                        start: { dateTime: params.startDateTime, timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone },
                        end: { dateTime: params.endDateTime, timeZone: Intl.DateTimeFormat().resolvedOptions().timeZone },
                        attendees: attendees
                    };
                    try {
                        const createdEvent = await apiCall('https://www.googleapis.com/calendar/v3/calendars/primary/events', { method: 'POST', body: JSON.stringify(eventData) });
                        addMessageToChat('agent', `Ich habe den Termin "${createdEvent.summary}" erstellt${attendees.length > 0 ? ' und die Teilnehmer eingeladen' : ''}.`);
                        await fetchCalendarEvents();
                    } catch (error) {
                        addMessageToChat('agent', `Entschuldigung, ich konnte den Termin nicht erstellen: ${error.message}`);
                    }
                    break;

                case "READ":
                     addMessageToChat('agent', 'Einen Moment, ich rufe die angeforderten Termine ab...');
                     await fetchCalendarEvents(params.startDateTime, params.endDateTime);
                     break;

                case "DELETE":
                    addMessageToChat('agent', `Okay, ich suche nach einem Termin mit dem Titel "${params.summary}" zum Löschen...`);
                    const events = await fetchCalendarEvents();
                    const eventToDelete = events.find(e => e.summary.toLowerCase() === params.summary.toLowerCase());
                    if (eventToDelete) {
                        try {
                            await apiCall(`https://www.googleapis.com/calendar/v3/calendars/primary/events/${eventToDelete.id}`, { method: 'DELETE' });
                            addMessageToChat('agent', `Der Termin "${eventToDelete.summary}" wurde erfolgreich gelöscht.`);
                            await fetchCalendarEvents();
                        } catch (error) {
                            addMessageToChat('agent', `Ich konnte den Termin nicht löschen: ${error.message}`);
                        }
                    } else {
                        addMessageToChat('agent', `Ich konnte keinen Termin mit dem Titel "${params.summary}" finden.`);
                    }
                    break;

                default:
                    addMessageToChat('agent', 'Der Kalender-Agent hat eine unbekannte Operation erhalten.');
            }
        }

        // --- SPECIALIST AGENT: CONTACT TOOL ---
        async function handleContactTool(params) {
            console.log("LOG: Kontakt-Agent wurde aktiviert mit Parametern:", params);
            const contactsPath = `artifacts/${appId}/users/${currentUserId}/contacts`;

            switch (params.operation) {
                case "CREATE":
                    try {
                        const contactRef = doc(db, contactsPath, params.email); // Use email as ID for simplicity
                        await setDoc(contactRef, { name: params.name, email: params.email, createdAt: serverTimestamp() });
                        addMessageToChat('agent', `Ich habe ${params.name} als neuen Kontakt gespeichert.`);
                        return { success: true, name: params.name, email: params.email };
                    } catch (error) {
                        console.error("LOG: Fehler beim Speichern des Kontakts:", error);
                        addMessageToChat('agent', `Ich konnte den Kontakt nicht speichern: ${error.message}`);
                        return { success: false, error: error.message };
                    }

                case "FIND":
                    try {
                        const q = query(collection(db, contactsPath), where("name", "==", params.name));
                        const querySnapshot = await getDocs(q);
                        if (!querySnapshot.empty) {
                            const contactData = querySnapshot.docs[0].data();
                            addMessageToChat('agent', `Ich habe den Kontakt ${contactData.name} gefunden. E-Mail: ${contactData.email}`);
                            return { success: true, ...contactData };
                        } else {
                            addMessageToChat('agent', `Ich konnte keinen Kontakt mit dem Namen "${params.name}" finden.`);
                            return { success: false, reason: "not_found" };
                        }
                    } catch (error) {
                         console.error("LOG: Fehler beim Finden des Kontakts:", error);
                         addMessageToChat('agent', `Bei der Suche nach dem Kontakt ist ein Fehler aufgetreten: ${error.message}`);
                         return { success: false, error: error.message };
                    }
                
                default:
                    addMessageToChat('agent', 'Der Kontakt-Agent hat eine unbekannte Operation erhalten.');
                    return { success: false, reason: "unknown_operation" };
            }
        }


        // --- COORDINATOR AGENT (GEMINI) ---
        async function callCoordinatorAgent(prompt) {
            addMessageToChat('user', prompt);
            agentLoader.classList.remove('hidden');
            chatInput.value = '';

            const schema = {
                type: "OBJECT",
                properties: {
                    thought: { type: "STRING", description: "Denke Schritt für Schritt darüber nach, was der Benutzer will und welche Werkzeuge benötigt werden." },
                    tool_to_use: { type: "STRING", enum: ["CALENDAR_TOOL", "CONTACT_TOOL", "CONVERSATION"] },
                    parameters: { type: "OBJECT", description: "Parameter für das ausgewählte Werkzeug. Z.B. für CALENDAR_TOOL: {operation: 'CREATE', summary: '...', ...}. Für CONTACT_TOOL: {operation: 'CREATE', name: '...', email: '...'}" }
                },
                required: ["thought", "tool_to_use"]
            };

            const system_prompt = `Du bist ein intelligenter Koordinator-Agent. Deine Aufgabe ist es, Benutzeranfragen zu analysieren und das passende Werkzeug (Tool) auszuwählen, um die Aufgabe zu erledigen.
            
            Verfügbare Werkzeuge:
            1.  CALENDAR_TOOL: Zur Verwaltung von Kalenderterminen.
                - Operationen: "CREATE", "READ", "DELETE".
                - Parameter für CREATE: summary, startDateTime (ISO 8601), endDateTime (ISO 8601), attendees (Array von E-Mail-Adressen, optional). Ein Termin dauert standardmäßig eine Stunde.
                - Parameter für READ: startDateTime (ISO 8601, optional), endDateTime (ISO 8601, optional).
                - Parameter für DELETE: summary.
            2.  CONTACT_TOOL: Zur Verwaltung von Kontakten.
                - Operationen: "CREATE", "FIND".
                - Parameter für CREATE: name, email.
                - Parameter für FIND: name.
            3.  CONVERSATION: Wenn keine spezielle Aktion erforderlich ist, sondern eine normale Unterhaltung.
            
            Heutiges Datum ist: ${new Date().toISOString()}.
            
            Analysiere den folgenden Benutzer-Prompt. Gib deine Überlegungen im "thought"-Feld an. Wähle dann das passende "tool_to_use" und fülle das "parameters"-Objekt mit allen extrahierten Informationen. Wenn eine Information fehlt (z.B. E-Mail für einen Kontakt), wähle trotzdem das passende Werkzeug und lass das Feld leer. Der Workflow wird das später behandeln.`;

            const payload = {
                contents: [{ parts: [{ text: `${system_prompt}\n\nBenutzer-Prompt: "${prompt}"` }] }],
                generationConfig: { responseMimeType: "application/json", responseSchema: schema }
            };

            const apiKey = ""; // Wird zur Laufzeit von der Umgebung bereitgestellt
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API-Fehler: ${response.statusText}`);
                const result = await response.json();
                
                if (!result.candidates || result.candidates.length === 0) throw new Error("Keine gültige Antwort von der AI erhalten.");
                
                const agentResponse = JSON.parse(result.candidates[0].content.parts[0].text);
                console.log("LOG: Antwort vom Koordinator-Agent:", agentResponse);
                addMessageToChat('agent', `*Gedanke des Agenten:* ${agentResponse.thought}`);
                await handleCoordinatorResponse(agentResponse);

            } catch (error) {
                console.error("LOG: Fehler bei der Kommunikation mit dem Koordinator-Agenten:", error);
                addMessageToChat('agent', 'Entschuldigung, ich habe gerade ein technisches Problem. Bitte versuchen Sie es später erneut.');
            } finally {
                agentLoader.classList.add('hidden');
            }
        }
        
        async function handleCoordinatorResponse(response) {
            const { tool_to_use, parameters } = response;

            // --- Multi-Agent Collaboration Logic ---
            if (tool_to_use === 'CALENDAR_TOOL' && parameters.operation === 'CREATE' && parameters.attendees && parameters.attendees.length > 0) {
                 // Check if attendee is a name, not an email
                 const attendeeName = parameters.attendees[0]; // Assuming one for now
                 if (!attendeeName.includes('@')) {
                    addMessageToChat('agent', `Okay, ich erstelle einen Termin. Zuerst suche ich nach "${attendeeName}" in Ihren Kontakten...`);
                    const contactResult = await handleContactTool({ operation: 'FIND', name: attendeeName });
                    if (contactResult.success) {
                        // Contact found, replace name with email and proceed
                        parameters.attendees = [contactResult.email];
                        await handleCalendarTool(parameters);
                    } else {
                         addMessageToChat('agent', `Ich konnte die E-Mail für "${attendeeName}" nicht finden. Ich erstelle den Termin ohne Einladung.`);
                         parameters.attendees = [];
                         await handleCalendarTool(parameters);
                    }
                    return;
                 }
            }

            // --- Standard Tool Handling ---
            switch (tool_to_use) {
                case "CALENDAR_TOOL":
                    await handleCalendarTool(parameters);
                    break;
                case "CONTACT_TOOL":
                    await handleContactTool(parameters);
                    break;
                case "CONVERSATION":
                default:
                    addMessageToChat('agent', 'Entschuldigung, das habe ich nicht verstanden. Ich kann Termine und Kontakte für Sie verwalten.');
                    break;
            }
        }

        // --- CHAT UI ---
        function addMessageToChat(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'agent-bubble'}`;
            messageElement.textContent = text;
            chatHistory.appendChild(messageElement);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        sendButton.addEventListener('click', () => {
            const prompt = chatInput.value.trim();
            if (prompt) callCoordinatorAgent(prompt);
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendButton.click();
        });
   </script>
</body>
</html>
