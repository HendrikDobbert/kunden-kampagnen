<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Kalender Agent</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chat-bubble {
            max-width: 75%;
            padding: 10px 15px;
            border-radius: 20px;
            word-wrap: break-word;
        }
        .user-bubble {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
        }
        .agent-bubble {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="main-container" class="container mx-auto p-4 md:p-8 max-w-6xl">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Ihr Kalender Agent</h1>
            <p class="text-gray-600 mt-2">Melden Sie sich an, um Ihre Termine zu verwalten und mit Ihrem KI-Assistenten zu chatten.</p>
        </header>

        <!-- Login Section -->
        <div id="login-section" class="text-center p-8 bg-white rounded-2xl shadow-lg">
            <h2 class="text-2xl font-semibold mb-4">Willkommen!</h2>
            <p class="mb-6">Bitte melden Sie sich mit Ihrem Google-Konto an, um fortzufahren.</p>
            <button id="login-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 inline-flex items-center">
                <svg class="w-6 h-6 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.986,36.68,44,31.016,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
                Mit Google anmelden
            </button>
        </div>

        <!-- App Content Section -->
        <div id="app-content" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Calendar View -->
            <div class="lg:col-span-1 bg-white p-6 rounded-2xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-2xl font-bold">Diese Woche</h2>
                    <button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg text-sm transition">Abmelden</button>
                </div>
                <div id="calendar-events" class="space-y-4">
                     <div id="calendar-loader" class="text-center p-4 hidden">
                         <div class="loader inline-block"></div>
                         <p class="mt-2 text-gray-500">Lade Termine...</p>
                     </div>
                </div>
            </div>

            <!-- Agent Chat -->
            <div class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-lg flex flex-col h-[70vh]">
                <h2 class="text-2xl font-bold mb-4 border-b pb-4">Chat mit Ihrem Agenten</h2>
                <div id="chat-history" class="flex-1 overflow-y-auto p-4 space-y-4 flex flex-col">
                </div>
                 <div id="agent-loader" class="p-4 self-start hidden">
                     <div class="flex items-center space-x-2">
                         <div class="loader"></div>
                         <span class="text-gray-500">Agent denkt nach...</span>
                     </div>
                 </div>
                <div class="mt-4 pt-4 border-t">
                    <div class="flex space-x-3">
                        <input type="text" id="chat-input" class="flex-1 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="Fragen Sie etwas...">
                        <button id="send-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition duration-300">Senden</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

   <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, GoogleAuthProvider, signOut, onAuthStateChanged, signInWithRedirect, getRedirectResult } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // --- CONFIGURATION ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyDA2pW52QXBfU17P6DWXqfUVVm4mPAIuqQ",
            authDomain: "sylvan-chess-418211.firebaseapp.com",
            projectId: "sylvan-chess-418211",
            storageBucket: "sylvan-chess-418211.appspot.com",
            messagingSenderId: "384756172708",
            appId: "1:384756172708:web:84caf479fca15c1831e331"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // --- INITIALIZATION ---
        setLogLevel('debug');
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM ELEMENTS ---
        const loginSection = document.getElementById('login-section');
        const appContent = document.getElementById('app-content');
        const loginButton = document.getElementById('login-button');
        const logoutButton = document.getElementById('logout-button');
        const calendarEventsContainer = document.getElementById('calendar-events');
        const chatHistory = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendButton = document.getElementById('send-button');
        const calendarLoader = document.getElementById('calendar-loader');
        const agentLoader = document.getElementById('agent-loader');

        let accessToken = null;
        let currentUserId = null;

        // --- AUTHENTICATION FLOW ---

        // Function to update the UI based on auth state
        async function updateUI(user) {
            if (user) {
                console.log("UI Update: User is signed in.", user.uid);
                currentUserId = user.uid;
                loginSection.classList.add('hidden');
                appContent.classList.remove('hidden');
                
                if (accessToken) {
                    chatHistory.innerHTML = '';
                    addMessageToChat('agent', 'Hallo! Ich bin Ihr Kalender-Agent. Wie kann ich Ihnen helfen?');
                    await fetchCalendarEvents();
                } else {
                    // This case can happen if the page is reloaded after the access token has expired.
                    // The onAuthStateChanged still sees a user, but getRedirectResult didn't provide a new token.
                    chatHistory.innerHTML = '';
                    calendarEventsContainer.innerHTML = '<p class="text-gray-500">Bitte melden Sie sich ab und erneut an, um den Kalenderzugriff zu erneuern.</p>';
                    addMessageToChat('agent', 'Sie sind angemeldet, aber der Zugriff auf den Kalender ist abgelaufen. Bitte melden Sie sich ab und erneut an, um den Zugriff zu erneuern.');
                }
            } else {
                console.log("UI Update: No user. Showing login screen.");
                accessToken = null;
                currentUserId = null;
                loginSection.classList.remove('hidden');
                appContent.classList.add('hidden');
                calendarEventsContainer.innerHTML = '';
                chatHistory.innerHTML = '';
            }
        }

        // 1. Process the redirect result on page load.
        getRedirectResult(auth)
            .then((result) => {
                if (result) {
                    console.log("Redirect result successfully processed.");
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    accessToken = credential.accessToken;
                }
            })
            .catch((error) => {
                console.error("Error processing redirect result:", error);
            })
            .finally(() => {
                // 2. Attach the listener AFTER the redirect has been processed.
                console.log("Attaching onAuthStateChanged listener.");
                onAuthStateChanged(auth, updateUI);
            });

        loginButton.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            provider.addScope('https://www.googleapis.com/auth/calendar.readonly');
            provider.addScope('https://www.googleapis.com/auth/calendar.events');
            signInWithRedirect(auth, provider);
        });

        logoutButton.addEventListener('click', () => {
            signOut(auth);
        });

        // --- GOOGLE CALENDAR API ---
        async function fetchCalendarEvents() {
            if (!accessToken) {
                addMessageToChat('agent', 'Authentifizierungstoken nicht gefunden. Bitte erneut anmelden.');
                return;
            }
            calendarLoader.classList.remove('hidden');
            calendarEventsContainer.innerHTML = '';

            const now = new Date();
            const timeMin = new Date(now.getFullYear(), now.getMonth(), now.getDate() - now.getDay() + 1).toISOString();
            const timeMax = new Date(now.getFullYear(), now.getMonth(), now.getDate() + (7 - now.getDay())).toISOString();

            try {
                const response = await fetch(`https://www.googleapis.com/calendar/v3/calendars/primary/events?timeMin=${timeMin}&timeMax=${timeMax}&singleEvents=true&orderBy=startTime`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });

                if (!response.ok) {
                    throw new Error(`Fehler beim Abrufen von Kalenderdaten: ${response.statusText}`);
                }

                const data = await response.json();
                calendarLoader.classList.add('hidden');
                if (data.items && data.items.length > 0) {
                    displayEvents(data.items);
                } else {
                    calendarEventsContainer.innerHTML = '<p class="text-gray-500">Keine Termine für diese Woche gefunden.</p>';
                }
            } catch (error) {
                console.error("Fehler beim Abrufen von Kalenderereignissen:", error);
                calendarLoader.classList.add('hidden');
                calendarEventsContainer.innerHTML = `<p class="text-red-500">Fehler: ${error.message}</p>`;
            }
        }

        function displayEvents(events) {
            calendarEventsContainer.innerHTML = '';
            events.forEach(event => {
                const start = event.start.dateTime || event.start.date;
                const startDate = new Date(start);
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
                const formattedDate = event.start.dateTime ? startDate.toLocaleDateString('de-DE', options) : startDate.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                const eventElement = document.createElement('div');
                eventElement.className = 'p-4 bg-gray-50 rounded-lg border border-gray-200';
                eventElement.innerHTML = `
                    <h3 class="font-semibold text-blue-600">${event.summary}</h3>
                    <p class="text-sm text-gray-600">${formattedDate}</p>
                `;
                calendarEventsContainer.appendChild(eventElement);
            });
        }

        async function createCalendarEvent(summary, startDateTime, endDateTime) {
            if (!accessToken) {
                addMessageToChat('agent', 'Authentifizierungstoken nicht gefunden. Bitte erneut anmelden.');
                return null;
            }

            const event = {
                'summary': summary,
                'start': { 'dateTime': startDateTime, 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone },
                'end': { 'dateTime': endDateTime, 'timeZone': Intl.DateTimeFormat().resolvedOptions().timeZone },
            };

            try {
                const response = await fetch('https://www.googleapis.com/calendar/v3/calendars/primary/events', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(event)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Fehler beim Erstellen des Termins: ${errorData.error.message}`);
                }

                const createdEvent = await response.json();
                return createdEvent;

            } catch (error) {
                console.error("Fehler beim Erstellen des Kalenderereignisses:", error);
                addMessageToChat('agent', `Entschuldigung, ich konnte den Termin nicht erstellen. Fehler: ${error.message}`);
                return null;
            }
        }

        // --- FIRESTORE DATABASE ---
        async function saveEventToFirestore(event) {
            if (!currentUserId || !event) return;
            try {
                const eventRef = doc(collection(db, "artifacts", appId, "users", currentUserId, "calendarEvents"), event.id);
                await setDoc(eventRef, {
                    googleEventId: event.id,
                    summary: event.summary,
                    startTime: event.start.dateTime,
                    endTime: event.end.dateTime,
                    link: event.htmlLink,
                    createdAt: serverTimestamp()
                });
                console.log("Ereignis in Firestore gespeichert:", event.id);
            } catch (error) {
                console.error("Fehler beim Speichern des Ereignisses in Firestore:", error);
                addMessageToChat('agent', 'Ich habe den Termin in Ihrem Kalender erstellt, konnte ihn aber nicht in meiner Datenbank speichern.');
            }
        }

        // --- AI AGENT (GEMINI) ---
        async function callAgent(prompt) {
            addMessageToChat('user', prompt);
            agentLoader.classList.remove('hidden');
            chatInput.value = '';

            const schema = {
                type: "OBJECT",
                properties: {
                    action: {
                        type: "STRING",
                        enum: ["CREATE_EVENT", "READ_EVENTS", "UNSUPPORTED"]
                    },
                    summary: { type: "STRING" },
                    startDateTime: { type: "STRING" },
                    endDateTime: { type: "STRING" }
                },
                required: ["action"]
            };

            const payload = {
                contents: [{
                    parts: [{
                        text: `Du bist ein Kalender-Agent. Deine Aufgabe ist es, die Absicht des Benutzers zu analysieren und entweder einen Kalendertermin zu erstellen oder bestehende Termine zu lesen.
                        Heutiges Datum ist: ${new Date().toISOString()}.
                        Analysiere den folgenden Benutzer-Prompt und gib eine JSON-Antwort zurück, die dem Schema entspricht.
                        - Wenn der Benutzer einen Termin erstellen möchte, setze 'action' auf 'CREATE_EVENT' und extrahiere 'summary', 'startDateTime' und 'endDateTime' (im ISO 8601 Format). Ein Termin dauert standardmäßig eine Stunde, wenn keine Endzeit angegeben ist.
                        - Wenn der Benutzer seine Termine sehen möchte, setze 'action' auf 'READ_EVENTS'.
                        - Wenn du die Anfrage nicht verstehst, setze 'action' auf 'UNSUPPORTED'.
                        
                        Benutzer-Prompt: "${prompt}"`
                    }]
                }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: schema
                }
            };

            const apiKey = ""; // Wird von der Umgebung bereitgestellt
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API-Fehler: ${response.statusText}`);
                }

                const result = await response.json();
                const agentResponseText = result.candidates[0].content.parts[0].text;
                const agentAction = JSON.parse(agentResponseText);

                handleAgentAction(agentAction);

            } catch (error) {
                console.error("Fehler bei der Kommunikation mit dem Agenten:", error);
                addMessageToChat('agent', 'Entschuldigung, ich habe gerade ein technisches Problem. Bitte versuchen Sie es später erneut.');
            } finally {
                agentLoader.classList.add('hidden');
            }
        }

        async function handleAgentAction(action) {
            switch (action.action) {
                case "CREATE_EVENT":
                    if (action.summary && action.startDateTime && action.endDateTime) {
                        const createdEvent = await createCalendarEvent(action.summary, action.startDateTime, action.endDateTime);
                        if (createdEvent) {
                            addMessageToChat('agent', `Ich habe den Termin "${createdEvent.summary}" für Sie erstellt.`);
                            await saveEventToFirestore(createdEvent);
                            await fetchCalendarEvents();
                        }
                    } else {
                        addMessageToChat('agent', 'Mir fehlen einige Informationen, um den Termin zu erstellen. Bitte geben Sie einen Titel, ein Startdatum und eine Startzeit an.');
                    }
                    break;
                case "READ_EVENTS":
                    addMessageToChat('agent', 'Klar, ich schaue nach Ihren Terminen für diese Woche.');
                    await fetchCalendarEvents();
                    break;
                case "UNSUPPORTED":
                default:
                    addMessageToChat('agent', 'Entschuldigung, das habe ich nicht verstanden. Ich kann Termine für Sie erstellen oder Ihre Termine für diese Woche anzeigen.');
                    break;
            }
        }

        // --- CHAT UI ---
        function addMessageToChat(sender, text) {
            const messageElement = document.createElement('div');
            messageElement.className = `chat-bubble ${sender === 'user' ? 'user-bubble' : 'agent-bubble'}`;
            messageElement.textContent = text;
            chatHistory.appendChild(messageElement);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }

        sendButton.addEventListener('click', () => {
            const prompt = chatInput.value.trim();
            if (prompt) {
                callAgent(prompt);
            }
        });

        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendButton.click();
            }
        });
   </script>
</body>
</html>
